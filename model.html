<!DOCTYPE html>
<head>
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<title>SixersAR</title>
	<!-- include three.js library -->
	<script src='js/three.js'></script>
	<script src='js/FBXLoader.js'></script>
	<script src='js/inflate.min.js'></script>
	<script src='js/OrbitControls.js'></script>
	<script src='js/FBXLoader.js'></script>
	<script src="js/stats.min.js"></script>
		<script src="js/curves/NURBSCurve.js"></script>
		<script src="js/curves/NURBSUtils.js"></script>

	<!-- include jsartookit -->
	<script src="jsartoolkit5/artoolkit.min.js"></script>
	<script src="jsartoolkit5/artoolkit.api.js"></script>
	<!-- include threex.artoolkit -->
	<script src="threex/threex-artoolkitsource.js"></script>
	<script src="threex/threex-artoolkitcontext.js"></script>
	<script src="threex/threex-arbasecontrols.js"></script>
	<script src="threex/threex-armarkercontrols.js"></script>
</head>

<body style='margin : 0px; overflow: hidden; font-family: Monospace;'>

<!-- 
  Example created by Lee Stemkoski: https://github.com/stemkoski
  Based on the AR.js library and examples created by Jerome Etienne: https://github.com/jeromeetienne/AR.js/
-->

<script>

var scene, camera, renderer, light;

var arToolkitSource, arToolkitContext;

var markerNames, markerArray, currentMarkerName;

var objectArray;

var clock = new THREE.Clock();

			var mixers = [];

initialize();
animate();

function initialize()
{
	container = document.createElement( 'div' );
				document.body.appendChild( container );

	scene = new THREE.Scene();

				light = new THREE.HemisphereLight( 0xffffff, 0x444444 );
				light.position.set( 0, 200, 0 );
				scene.add( light );

				light = new THREE.DirectionalLight( 0xffffff );
				light.position.set( 0, 200, 100 );
				light.castShadow = true;
				light.shadow.camera.top = 180;
				light.shadow.camera.bottom = - 100;
				light.shadow.camera.left = - 120;
				light.shadow.camera.right = 120;
				scene.add( light );
				
	camera = new THREE.Camera();
	scene.add(camera);

	renderer = new THREE.WebGLRenderer({
		antialias : true,
		alpha: true
	});
	renderer.setClearColor(new THREE.Color('lightgrey'), 0)

	
	renderer.setPixelRatio( window.devicePixelRatio );

	renderer.setSize( 800, 600 );

				renderer.shadowMap.enabled = true;

	renderer.domElement.style.position = 'absolute'
	renderer.domElement.style.top = '0px'
	renderer.domElement.style.left = '0px'
	document.body.appendChild( renderer.domElement);

	clock = new THREE.Clock();
	deltaTime = 0;
	totalTime = 0;
	
	////////////////////////////////////////////////////////////
	// setup arToolkitSource
	////////////////////////////////////////////////////////////

	arToolkitSource = new THREEx.ArToolkitSource({
		sourceType : 'webcam',
	});

	function onResize()
	{
		arToolkitSource.onResize()	
		arToolkitSource.copySizeTo(renderer.domElement)	
		if ( arToolkitContext.arController !== null )
		{
			arToolkitSource.copySizeTo(arToolkitContext.arController.canvas)	
		}	
	}

	arToolkitSource.init(function onReady(){
		onResize()
	});
	
	// handle resize event
	window.addEventListener('resize', function(){
		onResize()
	});
	
	////////////////////////////////////////////////////////////
	// setup arToolkitContext
	////////////////////////////////////////////////////////////	

	// create atToolkitContext
	arToolkitContext = new THREEx.ArToolkitContext({
		cameraParametersUrl: 'data/camera_para.dat',
		detectionMode: 'mono'
	});
	
	// copy projection matrix to camera when initialization complete
	arToolkitContext.init( function onCompleted(){
		camera.projectionMatrix.copy( arToolkitContext.getProjectionMatrix() );
	});

	////////////////////////////////////////////////////////////
	// setup markerRoots
	////////////////////////////////////////////////////////////

	// build markerControls
	markerNames = ["pattern-marker (1)", "02_HenriquesPerry", "03_Maddinson", "04_Syd"];
	
	markerArray = [];
	objectArray = [];

	for (let i = 0; i < markerNames.length; i++)
	{
		let marker = new THREE.Group();
		scene.add(marker);
		markerArray.push(marker);
		
		let markerControls = new THREEx.ArMarkerControls(arToolkitContext, marker, {
			type: 'pattern', patternUrl: "data/" + markerNames[i] + ".patt",
		});
	}

	function onProgress(xhr) { console.log( (xhr.loaded / xhr.total * 100) + '% loaded' ); }
	function onError(xhr) { console.log( 'An error happened' ); }

				// model

								var loader1 = new THREE.FBXLoader();
				loader1.load( 'models/Healy.fbx', function ( object ) {

					object.scale.setScalar(0.01);
		            object.position.set(0, 0, 0); 

					object.mixer = new THREE.AnimationMixer( object );
					mixers.push( object.mixer );

					var action = object.mixer.clipAction( object.animations[ 0 ] );
					action.play();

					markerArray[0].add( object );

					objectArray[0] = object;

				} , onProgress, onError);

								// model
				var loader2 = new THREE.FBXLoader();
				loader2.load( 'models/HP.fbx', function ( object ) {

					object.scale.setScalar(0.007);
		            object.position.set(-0.4, 0, 0.15); 

					markerArray[1].add( object );

					objectArray[1] = object;

				} , onProgress, onError);

				// model
				var loader3 = new THREE.FBXLoader();
				loader3.load( 'models/Maddinson.fbx', function ( object ) {

					object.scale.setScalar(0.01);
		            object.position.set(0, 0, 0); 

					markerArray[2].add( object );

					objectArray[2] = object;

				} , onProgress, onError);

				var loader4 = new THREE.FBXLoader();
				loader4.load( 'models/Syd.fbx', function ( object ) {

					object.scale.setScalar(0.005);
		            object.position.set(0, 0, 0); 

					markerArray[3].add( object );

					objectArray[3] = object;

				} , onProgress, onError);

currentMarkerName = markerNames[0];

}


function update()
{
	let anyMarkerVisible = false;
	for (let i = 0; i < markerArray.length; i++)
	{
		if ( markerArray[i].visible )
		{
			anyMarkerVisible = true;
			if ( currentMarkerName != markerNames[i] )
			{
				currentMarkerName = markerNames[i];
				mixers = [];

					objectArray[i].mixer = new THREE.AnimationMixer( objectArray[i] );
					mixers.push( objectArray[i].mixer );

					var action = objectArray[i].mixer.clipAction( objectArray[i].animations[ 0 ] );
					action.play();

				// console.log("Switching to " + currentMarkerName);
			}
			break;
		}
	}

	if ( !anyMarkerVisible )
	{
	}

	// update artoolkit on every frame
	if ( arToolkitSource.ready !== false )
		arToolkitContext.update( arToolkitSource.domElement );
}


function animate()
{
requestAnimationFrame( animate );
				if ( mixers.length > 0 ) {
					for ( var i = 0; i < mixers.length; i ++ ) {
						mixers[ i ].update( clock.getDelta() );
					}
				}

				update();

				renderer.render( scene, camera );

}

</script>

</body>
</html>